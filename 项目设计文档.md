# 邮件发送系统项目设计文档

## 1. 项目概述
本项目旨在构建一个高效、灵活的邮件发送系统。支持批量导入收件人、管理多个发件箱、自定义邮件模版，并具备多线程并发发送、任务调度、Webhook通知等功能。系统采用前后端分离架构，容器化部署。

## 2. 技术架构

*   **前端 (Frontend)**: PHP (建议使用现代框架如 Laravel 或 Symfony，或仅作为 API 消费者/简单的 Web 界面)
*   **后端 (Backend)**: Python (建议使用 FastAPI 或 Flask)
*   **数据库 (Database)**: MySQL / MariaDB 5+
*   **容器化 (Containerization)**: Docker & Docker Compose
*   **通信协议**: SMTP / POP3

## 3. 功能模块设计

### 3.1 收件箱管理 (Recipient Management)
*   **批量导入/添加**: 支持 CSV/Excel 导入，支持手动添加。
*   **信息管理**: 字段包括邮箱地址、姓名、公司名称、备注。
*   **分组管理**: 支持创建、编辑、删除分组，将收件人分配到不同分组。
*   **状态管理**: 启用/停用收件人（停用后不发送）。
*   **数据清洗**:
    *   **格式校验**: 验证邮箱格式合法性。
    *   **去重**: 导入时自动去重。

### 3.2 发件箱管理 (Sender Management)
*   **账户管理**: 添加、登录验证、删除发件邮箱。
*   **协议支持**: SMTP (发送), POP3 (可选，用于验证或回信处理)。
*   **状态管理**: 启用/停用发件箱（停用后不参与发送任务）。

### 3.3 邮件模版管理 (Template Management)
*   **多主题支持**: 支持创建多个邮件主题/模版。
*   **编辑器**: 集成所见即所得 (WYSIWYG) 编辑器 (如 CKEditor, TinyMCE)。
*   **图片支持**: 支持在正文中插入图片。
*   **变量替换**: 支持动态变量 `{name}` (姓名), `{company}` (公司名称)。

### 3.4 任务调度与发送 (Task Scheduling & Sending)
*   **发送策略**:
    *   **随机组合**: 每次发送从可用资源中随机选择：发件箱 + 收件箱 + 邮件主题。
    *   **间隔控制**: 可设置发送间隔时间 (秒)。
    *   **分组绑定**: 支持指定“收件人分组”与特定“邮件主题”绑定发送。
    *   **过滤机制**: 自动过滤停用的收件人和发件箱。
*   **并发控制**:
    *   支持多线程/多进程发送。
    *   可配置并行任务数量。
*   **任务控制**:
    *   开始、暂停、取消任务。
*   **记录与监控**:
    *   实时显示当前任务状态。
    *   保存详细发送记录 (成功/失败、时间、使用的发件箱、收件人等)。
*   **通知**: 支持 Webhook 回调通知发送结果。

### 3.5 系统管理 (System Management)
*   **账户管理**: 系统管理员账户的增删改查。

## 4. 数据库设计 (ER图概念)

建议表结构如下：

*   **recipients (收件人表)**
    *   `id` (PK)
    *   `email` (Unique)
    *   `name`
    *   `company`
    *   `note`
    *   `group_id` (FK)
    *   `status` (Active/Inactive)
    *   `created_at`, `updated_at`

*   **recipient_groups (收件人分组表)**
    *   `id` (PK)
    *   `group_name`
    *   `description`

*   **senders (发件人表)**
    *   `id` (PK)
    *   `email` (Unique)
    *   `smtp_host`
    *   `smtp_port`
    *   `smtp_user`
    *   `smtp_password`
    *   `status` (Active/Inactive)

*   **templates (邮件模版表)**
    *   `id` (PK)
    *   `subject`
    *   `content` (HTML)
    *   `group_binding_id` (FK, Optional - 绑定特定收件人分组)

*   **sending_tasks (发送任务表)**
    *   `id` (PK)
    *   `status` (Running/Paused/Completed/Cancelled)
    *   `config` (JSON - 包含间隔、并发数等配置)
    *   `created_at`

*   **sending_logs (发送记录表)**
    *   `id` (PK)
    *   `task_id` (FK)
    *   `sender_id` (FK)
    *   `recipient_id` (FK)
    *   `template_id` (FK)
    *   `status` (Success/Failure)
    *   `error_message`
    *   `sent_at`

*   **users (系统用户表)**
    *   `id` (PK)
    *   `username`
    *   `password_hash`

## 5. 核心流程

### 5.1 发送任务执行流程
1.  **任务启动**: 用户在前端配置任务参数（间隔、并发数、分组绑定等），发起任务。
2.  **资源获取**:
    *   后端从 `recipients` 表获取所有状态为 Active 的收件人（可选根据分组筛选）。
    *   从 `senders` 表获取所有状态为 Active 的发件人。
    *   从 `templates` 表获取适用模版。
3.  **队列生成/调度**:
    *   根据并发设置，启动多个 Worker 线程/进程。
    *   Worker 循环执行：
        *   检查任务状态 (是否暂停/取消)。
        *   选取一个待发送收件人 (确保不重复发送)。
        *   随机选取一个可用发件箱。
        *   根据收件人分组选取对应模版 (如有绑定) 或随机选取模版。
        *   执行变量替换 (姓名、公司)。
        *   调用 SMTP 发送邮件。
        *   记录发送结果到 `sending_logs`。
        *   触发 Webhook (如有)。
        *   休眠指定间隔时间 (根据配置)。

## 6. 接口设计概要 (API)

*   `POST /api/login`: 用户登录
*   `GET /api/recipients`: 获取收件人列表
*   `POST /api/recipients/import`: 导入收件人
*   `GET /api/senders`: 获取发件箱列表
*   `POST /api/task/start`: 启动发送任务
*   `POST /api/task/pause`: 暂停任务
*   `GET /api/task/status`: 获取当前任务状态

## 7. 部署架构 (Docker)

*   **Container 1 (Frontend)**: PHP-FPM + Nginx (提供 Web 界面)
*   **Container 2 (Backend)**: Python (FastAPI/Flask + Gunicorn/Uvicorn)
*   **Container 3 (Database)**: MySQL/MariaDB
*   **Network**: 内部网络互通，对外暴露 Web 端口。
